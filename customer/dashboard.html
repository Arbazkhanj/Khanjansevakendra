<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard - Khan Jan Seva Kendra</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s;
            max-width: 350px;
        }
        
        .toast.show { transform: translateX(0); }
        .toast.success { background: #4caf50; }
        .toast.error { background: #f44336; }
        .toast.info { background: #2196f3; }
        
        /* Header */
        .customer-header {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }
        
        .logo-section img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #2196f3;
        }
        
        .header-nav {
            display: flex;
            align-items: center;
            gap: 25px;
        }
        
        .header-nav a {
            color: #666;
            text-decoration: none;
            font-weight: 600;
            transition: 0.3s;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 20px;
        }
        
        .header-nav a:hover, .header-nav a.active { 
            color: #2196f3; 
            background: #e3f2fd;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 25px;
            transition: 0.3s;
            position: relative;
        }
        
        .user-menu:hover { background: #f5f5f5; }
        
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            border-radius: 8px;
            min-width: 200px;
            margin-top: 10px;
            z-index: 1000;
        }
        
        .dropdown-menu.show { display: block; }
        
        .dropdown-menu a {
            display: block;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            transition: 0.3s;
        }
        
        .dropdown-menu a:hover { background: #f5f5f5; color: #2196f3; }
        
        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        /* Welcome Section */
        .welcome-card {
            background: linear-gradient(90deg, #2196f3, #21cbf3);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(33,150,243,0.3);
        }
        
        .welcome-text h2 { font-size: 28px; margin-bottom: 10px; }
        .welcome-stats { display: flex; gap: 30px; text-align: center; }
        .welcome-stat h3 { font-size: 32px; margin-bottom: 5px; }
        
        /* Section Styles */
        .section {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .section.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Category Sections */
        .category-section { margin-bottom: 40px; }
        
        .category-header {
            color: white;
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
        }
        
        /* Services Grid */
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .service-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            transition: 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            border-color: #2196f3;
        }
        
        .service-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(180deg, #2196f3, #21cbf3);
        }
        
        .service-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 15px;
        }
        
        .service-card h4 { margin-bottom: 8px; color: #333; font-size: 18px; }
        .service-card p { color: #666; font-size: 13px; margin-bottom: 15px; line-height: 1.5; }
        
        .service-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }
        
        .price-tag {
            background: #e3f2fd;
            color: #2196f3;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .apply-btn {
            background: linear-gradient(90deg, #2196f3, #21cbf3);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }
        
        .apply-btn:hover { transform: scale(1.05); }
        
        .online-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #4caf50;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        /* Applications Section */
        .applications-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            min-height: 500px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .section-header h2 {
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-tabs { display: flex; gap: 10px; }
        
        .filter-tab {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: 0.3s;
        }
        
        .filter-tab:hover, .filter-tab.active {
            background: #2196f3;
            color: white;
            border-color: #2196f3;
        }
        
        .applications-grid { display: grid; gap: 20px; }
        
        .application-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.3s;
        }
        
        .application-card:hover {
            border-color: #2196f3;
            transform: translateX(5px);
        }
        
        .app-info h4 { color: #333; margin-bottom: 5px; font-size: 18px; }
        .app-info p { color: #666; font-size: 14px; margin-bottom: 3px; }
        
        .app-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending { background: #fff3e0; color: #ef6c00; }
        .status-progress { background: #e3f2fd; color: #1565c0; }
        .status-completed { background: #e8f5e9; color: #2e7d32; }
        .status-rejected { background: #ffebee; color: #c62828; }
        
        .app-actions { display: flex; gap: 10px; }
        
        .action-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }
        
        .action-btn.view { background: #e3f2fd; color: #2196f3; }
        .action-btn.download { background: #e8f5e9; color: #4caf50; }
        .action-btn:hover { transform: scale(1.1); }
        
        /* Track Status Section */
        .track-container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }
        
        .track-box { margin-bottom: 30px; }
        
        .track-input-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .track-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
        }
        
        .track-input:focus { border-color: #2196f3; }
        
        .track-btn {
            background: linear-gradient(90deg, #2196f3, #21cbf3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .track-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(33,150,243,0.3);
        }
        
        .tracking-result {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
            display: none;
        }
        
        .tracking-result.show { display: block; }
        
        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            position: relative;
        }
        
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 4px;
            background: #e0e0e0;
            z-index: 0;
        }
        
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        
        .step-circle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            margin-bottom: 10px;
            transition: 0.3s;
        }
        
        .progress-step.active .step-circle { background: #2196f3; }
        .progress-step.completed .step-circle { background: #4caf50; }
        
        .step-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }
        
        /* Support Section */
        .support-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .support-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            transition: 0.3s;
        }
        
        .support-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        
        .support-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 20px;
        }
        
        .support-card h3 { margin-bottom: 10px; color: #333; }
        .support-card p { color: #666; margin-bottom: 20px; font-size: 14px; }
        
        .support-btn {
            background: linear-gradient(90deg, #2196f3, #21cbf3);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }
        
        /* Profile Section */
        .profile-container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .profile-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid #2196f3;
            margin-bottom: 15px;
            object-fit: cover;
        }
        
        .profile-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .form-group { margin-bottom: 20px; }
        .form-group.full-width { grid-column: 1 / -1; }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2196f3;
        }
        
        .save-btn {
            background: linear-gradient(90deg, #4caf50, #45a049);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            grid-column: 1 / -1;
            justify-self: center;
        }
        
        .save-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(76,175,80,0.4);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            margin: 30px auto;
            position: relative;
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            background: linear-gradient(90deg, #2196f3, #21cbf3);
            color: white;
            padding: 25px 30px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 { font-size: 24px; }
        
        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: 0.3s;
        }
        
        .close-btn:hover { background: rgba(255,255,255,0.3); }
        
        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .form-section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid #eee;
        }
        
        .form-section:last-child { border-bottom: none; }
        
        .form-section h3 {
            color: #2196f3;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .required::after {
            content: ' *';
            color: #f44336;
        }
        
        /* Document Upload */
        .document-list { display: grid; gap: 15px; }
        
        .document-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px dashed #ddd;
            transition: 0.3s;
        }
        
        .document-item:hover { border-color: #2196f3; background: #f0f7ff; }
        
        .document-item label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #333;
        }
        
        .document-item i { font-size: 24px; color: #2196f3; }
        .document-item input[type="file"] { display: none; }
        
        .file-name {
            margin-top: 10px;
            padding: 8px 12px;
            background: #e3f2fd;
            border-radius: 6px;
            font-size: 13px;
            color: #2196f3;
            display: none;
        }
        
        .file-name.show { display: block; }
        
        .upload-progress {
            margin-top: 10px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }
        
        .upload-progress.show { display: block; }
        
        .upload-progress-bar {
            height: 100%;
            background: #4caf50;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* Submit Section */
        .submit-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 0 0 16px 16px;
            text-align: center;
        }
        
        .submit-btn {
            background: linear-gradient(90deg, #4caf50, #45a049);
            color: white;
            border: none;
            padding: 15px 50px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(76,175,80,0.4);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Footer */
        .footer {
            background: rgba(0,0,0,0.3);
            color: white;
            text-align: center;
            padding: 30px;
            margin-top: 50px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .customer-header { flex-direction: column; gap: 15px; }
            .header-nav { flex-wrap: wrap; justify-content: center; }
            .welcome-card { flex-direction: column; text-align: center; }
            .services-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .modal-body { padding: 20px; }
            .profile-form { grid-template-columns: 1fr; }
            .track-input-group { flex-direction: column; }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            color: #ddd;
        }
        
        /* Remarks Display */
        .remarks-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
        }
        
        .remarks-box.rejected {
            background: #ffebee;
            border-left-color: #f44336;
        }
        
        .remarks-box label {
            font-weight: 600;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .remarks-box p {
            color: #333;
            margin-top: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: #667eea; font-weight: 600;">Loading...</p>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Header -->
    <header class="customer-header">
        <div class="logo-section" onclick="showSection('services')">
            <img src="shop.jpg" alt="Logo" onerror="this.src='https://via.placeholder.com/50'">
            <div>
                <h1 style="font-size: 20px;">Khan Jan Seva Kendra</h1>
                <p style="font-size: 12px; color: #666;">Customer Portal</p>
            </div>
        </div>
        
        <nav class="header-nav">
            <a href="#" class="active" id="nav-services" onclick="showSection('services')">Services</a>
            <a href="#" id="nav-applications" onclick="showSection('applications')">My Applications</a>
            <a href="#" id="nav-track" onclick="showSection('track')">Track Status</a>
            <a href="#" id="nav-support" onclick="showSection('support')">Support</a>
        </nav>
        
        <div class="user-menu" onclick="toggleDropdown(event)">
            <div style="text-align: right;">
                <p style="font-weight: 600;" id="userName">Loading...</p>
                <p style="font-size: 12px; color: #4caf50;"><i class="fas fa-circle" style="font-size: 8px;"></i> Online</p>
            </div>
            <img src="shop.jpg" alt="User" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #4caf50;" onerror="this.src='https://via.placeholder.com/40'">
            
            <div class="dropdown-menu" id="userDropdown">
                <a href="#" onclick="showSection('profile'); return false;"><i class="fas fa-user"></i> My Profile</a>
                <a href="#" onclick="viewDocuments(); return false;"><i class="fas fa-file-alt"></i> My Documents</a>
                <div style="border-top: 1px solid #eee; margin: 5px 0;"></div>
                <a href="#" onclick="logout(); return false;" style="color: #f44336;"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Welcome Card -->
        <div class="welcome-card">
            <div class="welcome-text">
                <h2>Welcome, <span id="welcomeName">Customer</span>! ðŸ‘‹</h2>
                <p>Apply for government services, track applications, and manage documents.</p>
            </div>
            <div class="welcome-stats">
                <div class="welcome-stat">
                    <h3 id="statTotal">0</h3>
                    <p>Total Services</p>
                </div>
                <div class="welcome-stat">
                    <h3 id="statPending">0</h3>
                    <p>Pending</p>
                </div>
                <div class="welcome-stat">
                    <h3 id="statCompleted">0</h3>
                    <p>Completed</p>
                </div>
            </div>
        </div>

        <!-- SERVICES SECTION -->
        <div id="section-services" class="section active">
            <div class="category-section">
                <div class="category-header">
                    <i class="fas fa-calculator"></i>
                    Tax & Financial Filing
                </div>
                <div class="services-grid" id="taxOnline"></div>
            </div>

            <div class="category-section">
                <div class="category-header">
                    <i class="fas fa-id-card"></i>
                    Registration / Application / Certificate
                </div>
                <div class="services-grid" id="regOnline"></div>
            </div>

            <div class="category-section">
                <div class="category-header">
                    <i class="fas fa-bolt"></i>
                    Bill Pay Services
                </div>
                <div class="services-grid" id="billOnline"></div>
            </div>
        </div>

        <!-- MY APPLICATIONS SECTION -->
        <div id="section-applications" class="section">
            <div class="applications-container">
                <div class="section-header">
                    <h2><i class="fas fa-list"></i> My Applications</h2>
                    <div class="filter-tabs">
                        <div class="filter-tab active" onclick="filterApplications('all')">All</div>
                        <div class="filter-tab" onclick="filterApplications('pending')">Pending</div>
                        <div class="filter-tab" onclick="filterApplications('progress')">In Progress</div>
                        <div class="filter-tab" onclick="filterApplications('completed')">Completed</div>
                        <div class="filter-tab" onclick="filterApplications('rejected')">Rejected</div>
                    </div>
                </div>
                <div class="applications-grid" id="applicationsList"></div>
                <div class="empty-state" id="emptyState" style="display: none;">
                    <i class="fas fa-inbox"></i>
                    <h3>No applications found</h3>
                    <p>You haven't applied for any services yet.</p>
                    <button class="apply-btn" onclick="showSection('services')" style="margin-top: 20px;">
                        Browse Services
                    </button>
                </div>
            </div>
        </div>

        <!-- TRACK STATUS SECTION -->
        <div id="section-track" class="section">
            <div class="track-container">
                <div class="track-box">
                    <i class="fas fa-search-location" style="font-size: 64px; color: #2196f3; margin-bottom: 20px;"></i>
                    <h2 style="color: #333; margin-bottom: 10px;">Track Your Application</h2>
                    <p style="color: #666; margin-bottom: 30px;">Enter your Application ID to check the current status</p>
                    
                    <div class="track-input-group">
                        <input type="text" class="track-input" id="trackAppId" placeholder="Enter Application ID (e.g., -APP123456)">
                        <button class="track-btn" onclick="trackApplication()">
                            <i class="fas fa-search"></i> Track
                        </button>
                    </div>
                </div>
                
                <div class="tracking-result" id="trackingResult">
                    <h3 style="color: #333; margin-bottom: 20px;">Application Status</h3>
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: left;">
                        <p><strong>Application ID:</strong> <span id="resultAppId"></span></p>
                        <p><strong>Service:</strong> <span id="resultService"></span></p>
                        <p><strong>Applied Date:</strong> <span id="resultDate"></span></p>
                        <p><strong>Current Status:</strong> <span id="resultStatus" style="font-weight: 600;"></span></p>
                        <div id="resultRemarks" class="remarks-box" style="display: none;">
                            <label>Admin Remarks</label>
                            <p id="remarksText"></p>
                        </div>
                    </div>
                    
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-step completed">
                            <div class="step-circle"><i class="fas fa-check"></i></div>
                            <span class="step-label">Submitted</span>
                        </div>
                        <div class="progress-step" id="stepReview">
                            <div class="step-circle"><i class="fas fa-clipboard-check"></i></div>
                            <span class="step-label">Under Review</span>
                        </div>
                        <div class="progress-step" id="stepProcess">
                            <div class="step-circle"><i class="fas fa-cog"></i></div>
                            <span class="step-label">Processing</span>
                        </div>
                        <div class="progress-step" id="stepComplete">
                            <div class="step-circle"><i class="fas fa-flag-checkered"></i></div>
                            <span class="step-label">Completed</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: left;">
                        <p style="color: #1565c0; font-size: 14px;">
                            <i class="fas fa-info-circle"></i> <span id="statusMessage"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SUPPORT SECTION -->
        <div id="section-support" class="section">
            <div class="support-container">
                <div class="support-card">
                    <div class="support-icon" style="background: #e3f2fd; color: #2196f3;">
                        <i class="fas fa-phone-alt"></i>
                    </div>
                    <h3>Call Us</h3>
                    <p>Speak directly with our support team</p>
                    <p style="font-size: 18px; font-weight: 700; color: #2196f3; margin-bottom: 20px;">+91 74590 64328</p>
                    <button class="support-btn" onclick="window.location.href='tel:+917459064328'">
                        <i class="fas fa-phone"></i> Call Now
                    </button>
                </div>
                
                <div class="support-card">
                    <div class="support-icon" style="background: #e8f5e9; color: #4caf50;">
                        <i class="fab fa-whatsapp"></i>
                    </div>
                    <h3>WhatsApp</h3>
                    <p>Chat with us on WhatsApp</p>
                    <p style="font-size: 18px; font-weight: 700; color: #4caf50; margin-bottom: 20px;">+91 74590 64328</p>
                    <button class="support-btn" style="background: linear-gradient(90deg, #4caf50, #45a049);" onclick="window.open('https://wa.me/917459064328', '_blank')">
                        <i class="fab fa-whatsapp"></i> Chat Now
                    </button>
                </div>
                
                <div class="support-card">
                    <div class="support-icon" style="background: #fff3e0; color: #ff9800;">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <h3>Email Support</h3>
                    <p>Send us an email for detailed queries</p>
                    <p style="font-size: 16px; font-weight: 700; color: #ff9800; margin-bottom: 20px;">nsdl.arbaz@gmail.com</p>
                    <button class="support-btn" style="background: linear-gradient(90deg, #ff9800, #f57c00);" onclick="window.location.href='mailto:nsdl.arbaz@gmail.com'">
                        <i class="fas fa-envelope"></i> Send Email
                    </button>
                </div>
                
                <div class="support-card">
                    <div class="support-icon" style="background: #f3e5f5; color: #9c27b0;">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h3>Live Chat</h3>
                    <p>Start a live chat session</p>
                    <p style="font-size: 14px; color: #9c27b0; margin-bottom: 20px;">Available 9 AM - 6 PM</p>
                    <button class="support-btn" style="background: linear-gradient(90deg, #9c27b0, #7b1fa2);" onclick="showToast('Live chat coming soon!', 'info')">
                        <i class="fas fa-comments"></i> Start Chat
                    </button>
                </div>
            </div>
        </div>

        <!-- PROFILE SECTION -->
        <div id="section-profile" class="section">
            <div class="profile-container">
                <div class="profile-header">
                    <img src="shop.jpg" alt="Profile" class="profile-avatar" id="profileAvatar" onerror="this.src='https://via.placeholder.com/120'">
                    <h2 id="profileNameDisplay">Customer Name</h2>
                    <p style="color: #666;" id="profileEmailDisplay">customer@email.com</p>
                </div>
                
                <form class="profile-form" onsubmit="saveProfile(event)">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="profileName" required>
                    </div>
                    <div class="form-group">
                        <label>Mobile Number</label>
                        <input type="tel" id="profileMobile" pattern="[0-9]{10}" required>
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="profileEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Date of Birth</label>
                        <input type="date" id="profileDob">
                    </div>
                    <div class="form-group full-width">
                        <label>Complete Address</label>
                        <textarea id="profileAddress" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>District</label>
                        <input type="text" id="profileDistrict">
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <select id="profileState">
                            <option value="">Select State</option>
                            <option value="up">Uttar Pradesh</option>
                            <option value="bihar">Bihar</option>
                            <option value="mp">Madhya Pradesh</option>
                            <option value="rajasthan">Rajasthan</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>PIN Code</label>
                        <input type="text" id="profilePincode" pattern="[0-9]{6}">
                    </div>
                    <div class="form-group">
                        <label>Aadhaar Number</label>
                        <input type="text" id="profileAadhaar" pattern="[0-9]{12}">
                    </div>
                    <div class="form-group">
                        <label>PAN Number</label>
                        <input type="text" id="profilePan" style="text-transform: uppercase;">
                    </div>
                    <button type="submit" class="save-btn">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Service Application Modal -->
    <div id="serviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 id="modalTitle">Service Application</h2>
                    <p id="modalSubtitle" style="opacity: 0.9; margin-top: 5px;">Fill in your details</p>
                </div>
                <button class="close-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="modal-body">
                <!-- Personal Information -->
                <div class="form-section">
                    <h3><i class="fas fa-user"></i> Personal Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Full Name (as per Aadhaar)</label>
                            <input type="text" id="appName" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Father's/Husband's Name</label>
                            <input type="text" id="appFatherName" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Date of Birth</label>
                            <input type="date" id="appDob" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Gender</label>
                            <select id="appGender" required>
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">Mobile Number</label>
                            <input type="tel" id="appMobile" pattern="[0-9]{10}" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Email Address</label>
                            <input type="email" id="appEmail" required>
                        </div>
                        <div class="form-group full-width">
                            <label class="required">Complete Address</label>
                            <textarea id="appAddress" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label class="required">District</label>
                            <input type="text" id="appDistrict" required>
                        </div>
                        <div class="form-group">
                            <label class="required">State</label>
                            <select id="appState" required>
                                <option value="">Select State</option>
                                <option value="up">Uttar Pradesh</option>
                                <option value="bihar">Bihar</option>
                                <option value="mp">Madhya Pradesh</option>
                                <option value="rajasthan">Rajasthan</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">PIN Code</label>
                            <input type="text" id="appPincode" pattern="[0-9]{6}" required>
                        </div>
                        <div class="form-group">
                            <label>Aadhaar Number</label>
                            <input type="text" id="appAadhaar" pattern="[0-9]{12}">
                        </div>
                        <div class="form-group">
                            <label>PAN Number</label>
                            <input type="text" id="appPan" style="text-transform: uppercase;">
                        </div>
                    </div>
                </div>

                <!-- Service Specific Fields -->
                <div class="form-section" id="serviceSpecificSection">
                    <h3><i class="fas fa-cog"></i> Service Specific Details</h3>
                    <div id="serviceSpecificFields"></div>
                </div>

                <!-- Document Upload -->
                <div class="form-section">
                    <h3><i class="fas fa-upload"></i> Required Documents</h3>
                    <div class="document-list" id="documentList"></div>
                </div>

                <!-- Additional Information -->
                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Additional Information</h3>
                    <div class="form-group">
                        <label>Any specific requirements or notes</label>
                        <textarea id="appNotes" rows="3" placeholder="Enter any additional information..."></textarea>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="appTerms" required style="width: auto;">
                            <span>I confirm that all information provided is correct and I agree to the terms and conditions.</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="submit-section">
                <button class="submit-btn" onclick="submitApplication()" id="submitBtn">
                    <span>Submit Application</span>
                </button>
                <p style="margin-top: 15px; color: #666; font-size: 14px;">
                    <i class="fas fa-lock"></i> Your information is secure and encrypted
                </p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 Khan Jan Seva Kendra | All Rights Reserved</p>
        <p style="margin-top: 10px; font-size: 14px;">
            <i class="fas fa-phone"></i> Helpline: +91 74590 64328 | 
            <i class="fas fa-envelope"></i> nsdl.arbaz@gmail.com
        </p>
    </footer>

    <!-- Firebase Scripts -->
    <script type="module">
        import { 
            auth, database, storage, ref, set, get, push, update, onValue, query, orderByChild, equalTo,
            storageRef, uploadBytes, getDownloadURL, signOut, onAuthStateChanged 
        } from './firebase-config.js';

        // Service Data
        const servicesData = {
            taxOnline: [
                { id: 'gst_filing_online', name: 'GST Filing Online', icon: 'fa-file-invoice-dollar', color: '#ff9800', price: 'â‚¹400', desc: 'Online GST filing with digital signature', docs: ['pan_card', 'gst_certificate', 'bank_statement'] },
                { id: 'itr_filing_online', name: 'Income Tax Filing Online', icon: 'fa-calculator', color: '#4caf50', price: 'â‚¹250', desc: 'E-filing of income tax returns', docs: ['pan_card', 'aadhaar', 'form16'] },
                { id: 'tds_online', name: 'TDS Services Online', icon: 'fa-percentage', color: '#2196f3', price: 'â‚¹350', desc: 'Online TDS filing and verification', docs: ['pan_card', 'tds_certificate'] }
            ],
            regOnline: [
                { id: 'pan_online', name: 'PAN Card Online', icon: 'fa-id-card', color: '#ff5722', price: 'â‚¹107', desc: 'Apply PAN card online', docs: ['aadhaar', 'digital_photo', 'digital_signature'] },
                { id: 'pan_correction_online', name: 'PAN Correction Online', icon: 'fa-edit', color: '#ff5722', price: 'â‚¹107', desc: 'Online PAN correction', docs: ['pan_card', 'aadhaar', 'proof_document'] },
                { id: 'aadhaar_update_online', name: 'Aadhaar Update Online', icon: 'fa-fingerprint', color: '#2196f3', price: 'â‚¹50', desc: 'Online Aadhaar update', docs: ['aadhaar', 'otp_verification'] },
                { id: 'aadhaar_enrolment_online', name: 'Aadhaar Enrolment Online', icon: 'fa-fingerprint', color: '#2196f3', price: 'Free', desc: 'Book Aadhaar enrollment appointment', docs: ['identity_proof', 'address_proof'] },
                { id: 'voter_online', name: 'Voter ID Online', icon: 'fa-vote-yea', color: '#9c27b0', price: 'Free', desc: 'Online voter ID application', docs: ['aadhaar', 'mobile_linked'] },
                { id: 'dl_online', name: 'Driving Licence Online', icon: 'fa-car', color: '#795548', price: 'â‚¹200', desc: 'Online DL services', docs: ['aadhaar', 'learner_license'] },
                { id: 'passport_online', name: 'Passport Online', icon: 'fa-passport', color: '#607d8b', price: 'â‚¹1500', desc: 'Online passport application', docs: ['aadhaar', 'documents_upload'] },
                { id: 'birth_cert_online', name: 'Birth Certificate Online', icon: 'fa-baby', color: '#e91e63', price: 'â‚¹50', desc: 'Apply birth certificate online', docs: ['hospital_record', 'parent_details'] },
                { id: 'death_cert_online', name: 'Death Certificate Online', icon: 'fa-cross', color: '#607d8b', price: 'â‚¹50', desc: 'Online death registration', docs: ['medical_certificate', 'applicant_details'] },
                { id: 'caste_online', name: 'Caste Certificate Online', icon: 'fa-certificate', color: '#ff9800', price: 'â‚¹50', desc: 'Online caste certificate', docs: ['existing_proof', 'residence_details'] },
                { id: 'domicile_online', name: 'Domicile Certificate Online', icon: 'fa-home', color: '#4caf50', price: 'â‚¹50', desc: 'Apply domicile online', docs: ['residence_proof', 'identity_proof'] },
                { id: 'income_online', name: 'Income Certificate Online', icon: 'fa-rupee-sign', color: '#2196f3', price: 'â‚¹50', desc: 'Online income certificate', docs: ['income_details', 'employer_info'] },
                { id: 'shop_online', name: 'Shop Registration Online', icon: 'fa-store', color: '#ff5722', price: 'â‚¹500', desc: 'Online shop registration', docs: ['business_details', 'address_proof', 'owner_id'] },
                { id: 'trade_online', name: 'Trade License Online', icon: 'fa-briefcase', color: '#9c27b0', price: 'â‚¹1000', desc: 'Online trade license', docs: ['business_reg', 'premises_proof'] },
                { id: 'police_ver_online', name: 'Police Verification Online', icon: 'fa-shield-alt', color: '#3f51b5', price: 'â‚¹200', desc: 'Online police verification', docs: ['aadhaar', 'purpose_details'] },
                { id: 'cert_verify_online', name: 'Certificate Verification Online', icon: 'fa-check-double', color: '#4caf50', price: 'â‚¹300', desc: 'Online certificate verification', docs: ['certificate_upload', 'institute_details'] },
                { id: 'gst_reg_online', name: 'GST Registration Online', icon: 'fa-file-invoice', color: '#ff9800', price: 'â‚¹999', desc: 'Online GST registration', docs: ['pan', 'aadhaar', 'business_proof'] }
            ],
            billOnline: [
                { id: 'electricity_online', name: 'Electricity Bill Online', icon: 'fa-bolt', color: '#ffeb3b', price: 'Free', desc: 'Online electricity payment', docs: ['consumer_number'] },
                { id: 'water_online', name: 'Water Bill Online', icon: 'fa-tint', color: '#2196f3', price: 'Free', desc: 'Online water bill payment', docs: ['connection_id'] },
                { id: 'gas_online', name: 'Gas Bill Online', icon: 'fa-fire', color: '#ff5722', price: 'Free', desc: 'Online gas bill payment', docs: ['consumer_number'] },
                { id: 'lic_online', name: 'LIC Premium Online', icon: 'fa-shield-alt', color: '#ff9800', price: 'Free', desc: 'Online LIC payment', docs: ['policy_number'] },
                { id: 'fastag_online', name: 'Fastag Recharge Online', icon: 'fa-road', color: '#4caf50', price: 'Free', desc: 'Online Fastag recharge', docs: ['vehicle_number'] }
            ]
        };

        // Document Configuration
        const documentConfig = {
            aadhaar: { name: 'Aadhaar Card', icon: 'fa-fingerprint', accept: '.pdf,.jpg,.jpeg,.png' },
            pan_card: { name: 'PAN Card', icon: 'fa-id-card', accept: '.pdf,.jpg,.jpeg,.png' },
            form16: { name: 'Form 16', icon: 'fa-file-alt', accept: '.pdf' },
            gst_certificate: { name: 'GST Certificate', icon: 'fa-certificate', accept: '.pdf' },
            tds_certificate: { name: 'TDS Certificate', icon: 'fa-percentage', accept: '.pdf' },
            bank_statement: { name: 'Bank Statement (Last 3 months)', icon: 'fa-university', accept: '.pdf' },
            digital_photo: { name: 'Digital Photo', icon: 'fa-camera', accept: '.jpg,.jpeg,.png' },
            digital_signature: { name: 'Digital Signature', icon: 'fa-signature', accept: '.jpg,.jpeg,.png' },
            proof_document: { name: 'Proof Document', icon: 'fa-file', accept: '.pdf,.jpg,.jpeg,.png' },
            otp_verification: { name: 'Mobile OTP Verification', icon: 'fa-mobile-alt', accept: '.pdf' },
            identity_proof: { name: 'Identity Proof', icon: 'fa-user-shield', accept: '.pdf,.jpg,.jpeg,.png' },
            address_proof: { name: 'Address Proof', icon: 'fa-home', accept: '.pdf,.jpg,.jpeg,.png' },
            mobile_linked: { name: 'Mobile Linked Document', icon: 'fa-mobile', accept: '.pdf,.jpg,.jpeg,.png' },
            learner_license: { name: 'Learner License', icon: 'fa-id-card', accept: '.pdf,.jpg,.jpeg,.png' },
            documents_upload: { name: 'Documents Upload', icon: 'fa-cloud-upload-alt', accept: '.pdf,.jpg,.jpeg,.png' },
            hospital_record: { name: 'Hospital Record', icon: 'fa-hospital', accept: '.pdf,.jpg,.jpeg,.png' },
            parent_details: { name: 'Parent Details Document', icon: 'fa-users', accept: '.pdf,.jpg,.jpeg,.png' },
            medical_certificate: { name: 'Medical Certificate', icon: 'fa-user-md', accept: '.pdf,.jpg,.jpeg,.png' },
            applicant_details: { name: 'Applicant Details', icon: 'fa-user', accept: '.pdf,.jpg,.jpeg,.png' },
            existing_proof: { name: 'Existing Proof', icon: 'fa-check-circle', accept: '.pdf,.jpg,.jpeg,.png' },
            residence_details: { name: 'Residence Details', icon: 'fa-home', accept: '.pdf,.jpg,.jpeg,.png' },
            residence_proof: { name: 'Residence Proof', icon: 'fa-home', accept: '.pdf,.jpg,.jpeg,.png' },
            income_details: { name: 'Income Details', icon: 'fa-money-bill', accept: '.pdf,.jpg,.jpeg,.png' },
            employer_info: { name: 'Employer Information', icon: 'fa-building', accept: '.pdf,.jpg,.jpeg,.png' },
            business_details: { name: 'Business Details', icon: 'fa-briefcase', accept: '.pdf,.jpg,.jpeg,.png' },
            owner_id: { name: 'Owner ID Proof', icon: 'fa-id-card', accept: '.pdf,.jpg,.jpeg,.png' },
            business_reg: { name: 'Business Registration', icon: 'fa-registered', accept: '.pdf,.jpg,.jpeg,.png' },
            premises_proof: { name: 'Premises Proof', icon: 'fa-building', accept: '.pdf,.jpg,.jpeg,.png' },
            purpose_details: { name: 'Purpose Details', icon: 'fa-info-circle', accept: '.pdf,.jpg,.jpeg,.png' },
            certificate_upload: { name: 'Certificate Upload', icon: 'fa-certificate', accept: '.pdf,.jpg,.jpeg,.png' },
            institute_details: { name: 'Institute Details', icon: 'fa-university', accept: '.pdf,.jpg,.jpeg,.png' },
            business_proof: { name: 'Business Proof', icon: 'fa-business-time', accept: '.pdf,.jpg,.jpeg,.png' },
            pan: { name: 'PAN Card', icon: 'fa-id-card', accept: '.pdf,.jpg,.jpeg,.png' },
            consumer_number: { name: 'Consumer Number Details', icon: 'fa-hashtag', accept: '.pdf,.jpg,.jpeg,.png' },
            connection_id: { name: 'Connection ID', icon: 'fa-plug', accept: '.pdf,.jpg,.jpeg,.png' },
            policy_number: { name: 'Policy Document', icon: 'fa-file-contract', accept: '.pdf,.jpg,.jpeg,.png' },
            vehicle_number: { name: 'Vehicle RC', icon: 'fa-car', accept: '.pdf,.jpg,.jpeg,.png' }
        };

        // Global Variables
        let currentUser = null;
        let currentService = null;
        let uploadedFiles = {};
        let currentFilter = 'all';
        let applicationsListener = null;

        // Toast Notification System
        window.showToast = function(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i> ${message}`;
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        };

        // Show/Hide Loading
        window.showLoading = function(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        };

        // Check Auth State
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserData();
                renderServices();
                setupRealtimeListeners();
                showLoading(false);
            } else {
                window.location.href = 'login.html';
            }
        });

        // Load User Data from Firebase
        async function loadUserData() {
            try {
                const userRef = ref(database, `users/${currentUser.uid}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    document.getElementById('userName').textContent = userData.name || currentUser.displayName || 'Customer';
                    document.getElementById('welcomeName').textContent = userData.name || currentUser.displayName || 'Customer';
                    document.getElementById('profileNameDisplay').textContent = userData.name || currentUser.displayName || 'Customer';
                    document.getElementById('profileEmailDisplay').textContent = currentUser.email;
                    
                    // Pre-fill form
                    document.getElementById('appName').value = userData.name || '';
                    document.getElementById('appMobile').value = userData.mobile || '';
                    document.getElementById('appEmail').value = currentUser.email || '';
                    
                    // Load profile data
                    document.getElementById('profileName').value = userData.name || '';
                    document.getElementById('profileMobile').value = userData.mobile || '';
                    document.getElementById('profileEmail').value = currentUser.email || '';
                    document.getElementById('profileDob').value = userData.dob || '';
                    document.getElementById('profileAddress').value = userData.address || '';
                    document.getElementById('profileDistrict').value = userData.district || '';
                    document.getElementById('profileState').value = userData.state || '';
                    document.getElementById('profilePincode').value = userData.pincode || '';
                    document.getElementById('profileAadhaar').value = userData.aadhaar || '';
                    document.getElementById('profilePan').value = userData.pan || '';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Failed to load user data', 'error');
            }
        }

        // Setup Real-time Listeners
        function setupRealtimeListeners() {
            // Listen for applications changes
            const appsRef = ref(database, `applications/${currentUser.uid}`);
            applicationsListener = onValue(appsRef, (snapshot) => {
                updateStats();
                if (document.getElementById('section-applications').classList.contains('active')) {
                    loadMyApplications();
                }
            });
        }

        // Update Statistics
        async function updateStats() {
            try {
                const appsRef = ref(database, `applications/${currentUser.uid}`);
                const snapshot = await get(appsRef);
                
                if (snapshot.exists()) {
                    const apps = Object.values(snapshot.val());
                    document.getElementById('statTotal').textContent = apps.length;
                    document.getElementById('statPending').textContent = apps.filter(a => a.status === 'pending').length;
                    document.getElementById('statCompleted').textContent = apps.filter(a => a.status === 'completed').length;
                } else {
                    document.getElementById('statTotal').textContent = '0';
                    document.getElementById('statPending').textContent = '0';
                    document.getElementById('statCompleted').textContent = '0';
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Render Services
        window.renderServices = function() {
            renderCategory('taxOnline', servicesData.taxOnline);
            renderCategory('regOnline', servicesData.regOnline);
            renderCategory('billOnline', servicesData.billOnline);
        };

        function renderCategory(elementId, services) {
            const container = document.getElementById(elementId);
            container.innerHTML = services.map(service => `
                <div class="service-card" onclick="openServiceModal('${service.id}')">
                    <span class="online-badge"><i class="fas fa-wifi"></i> ONLINE</span>
                    <div class="service-icon" style="background: ${service.color}20; color: ${service.color};">
                        <i class="fas ${service.icon}"></i>
                    </div>
                    <h4>${escapeHtml(service.name)}</h4>
                    <p>${escapeHtml(service.desc)}</p>
                    <div class="service-meta">
                        <span class="price-tag">${service.price}</span>
                        <button class="apply-btn">Apply <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Section Navigation
        window.showSection = function(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.header-nav a').forEach(a => a.classList.remove('active'));
            
            document.getElementById('section-' + sectionName).classList.add('active');
            
            const navMap = {
                'services': 'nav-services',
                'applications': 'nav-applications',
                'track': 'nav-track',
                'support': 'nav-support',
                'profile': 'nav-services'
            };
            
            if(navMap[sectionName]) {
                document.getElementById(navMap[sectionName]).classList.add('active');
            }
            
            document.getElementById('userDropdown').classList.remove('show');
            
            if(sectionName === 'applications') {
                loadMyApplications();
            }
        };

        // Load My Applications from Firebase
        async function loadMyApplications() {
            try {
                showLoading(true);
                const appsRef = ref(database, `applications/${currentUser.uid}`);
                const snapshot = await get(appsRef);
                
                const container = document.getElementById('applicationsList');
                const emptyState = document.getElementById('emptyState');
                
                let apps = [];
                if (snapshot.exists()) {
                    apps = Object.entries(snapshot.val()).map(([key, value]) => ({
                        firebaseKey: key,
                        ...value
                    }));
                }
                
                // Filter applications
                let filteredApps = apps;
                if(currentFilter !== 'all') {
                    filteredApps = apps.filter(a => a.status === currentFilter);
                }
                
                if(filteredApps.length === 0) {
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                    showLoading(false);
                    return;
                }
                
                emptyState.style.display = 'none';
                
                container.innerHTML = filteredApps.sort((a, b) => b.submittedAt - a.submittedAt).map(app => {
                    const statusClass = {
                        'pending': 'status-pending',
                        'progress': 'status-progress',
                        'completed': 'status-completed',
                        'rejected': 'status-rejected'
                    }[app.status] || 'status-pending';
                    
                    const statusText = {
                        'pending': 'Pending',
                        'progress': 'In Progress',
                        'completed': 'Completed',
                        'rejected': 'Rejected'
                    }[app.status] || 'Pending';
                    
                    let remarksHtml = '';
                    if(app.remarks) {
                        remarksHtml = `<div class="remarks-box ${app.status === 'rejected' ? 'rejected' : ''}" style="margin-top: 10px; font-size: 12px;">
                            <strong>Remarks:</strong> ${escapeHtml(app.remarks)}
                        </div>`;
                    }
                    
                    return `
                        <div class="application-card">
                            <div class="app-info">
                                <h4>${escapeHtml(app.serviceName)}</h4>
                                <p><i class="fas fa-hashtag"></i> Application ID: <strong>${app.firebaseKey}</strong></p>
                                <p><i class="fas fa-calendar"></i> Applied: ${new Date(app.submittedAt).toLocaleDateString()}</p>
                                ${remarksHtml}
                            </div>
                            <div style="text-align: center;">
                                <span class="app-status ${statusClass}">${statusText}</span>
                                <div class="app-actions" style="margin-top: 10px;">
                                    <button class="action-btn view" onclick="viewApplicationDetails('${app.firebaseKey}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn download" onclick="downloadApplication('${app.firebaseKey}')" title="Download Receipt">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                showLoading(false);
            } catch (error) {
                console.error('Error loading applications:', error);
                showToast('Failed to load applications', 'error');
                showLoading(false);
            }
        }

        // Filter Applications
        window.filterApplications = function(filter) {
            currentFilter = filter;
            document.querySelectorAll('#section-applications .filter-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            loadMyApplications();
        };

        // View Application Details
        window.viewApplicationDetails = async function(appKey) {
            try {
                const appRef = ref(database, `applications/${currentUser.uid}/${appKey}`);
                const snapshot = await get(appRef);
                
                if(!snapshot.exists()) {
                    showToast('Application not found', 'error');
                    return;
                }
                
                const app = snapshot.val();
                let details = `Application Details:\n\n`;
                details += `ID: ${appKey}\n`;
                details += `Service: ${app.serviceName}\n`;
                details += `Status: ${app.status.toUpperCase()}\n`;
                if(app.remarks) {
                    details += `Remarks: ${app.remarks}\n`;
                }
                details += `Applied: ${new Date(app.submittedAt).toLocaleString()}\n\n`;
                details += `Personal Info:\n`;
                details += `Name: ${app.personalInfo.name}\n`;
                details += `Mobile: ${app.personalInfo.mobile}\n`;
                details += `Email: ${app.personalInfo.email}\n`;
                details += `Address: ${app.personalInfo.address}\n\n`;
                details += `Documents: ${app.documents.map(d => d.name).join(', ')}`;
                
                alert(details);
            } catch (error) {
                console.error('Error viewing application:', error);
                showToast('Failed to load application details', 'error');
            }
        };

        // Download Application Receipt
        window.downloadApplication = async function(appKey) {
            try {
                const appRef = ref(database, `applications/${currentUser.uid}/${appKey}`);
                const snapshot = await get(appRef);
                
                if(!snapshot.exists()) return;
                
                const app = snapshot.val();
                const receipt = `
Khan Jan Seva Kendra - Application Receipt
------------------------------------------
Application ID: ${appKey}
Service: ${app.serviceName}
Date: ${new Date(app.submittedAt).toLocaleString()}
Status: ${app.status.toUpperCase()}
${app.remarks ? `Remarks: ${app.remarks}` : ''}

Applicant Details:
Name: ${app.personalInfo.name}
Mobile: ${app.personalInfo.mobile}
Email: ${app.personalInfo.email}

Documents Submitted:
${app.documents.map(d => `- ${d.name} (${d.url})`).join('\n')}

Thank you for using our services!
                `;
                
                const blob = new Blob([receipt], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Receipt_${appKey}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('Receipt downloaded', 'success');
            } catch (error) {
                console.error('Error downloading receipt:', error);
                showToast('Failed to download receipt', 'error');
            }
        };

        // Track Application
        window.trackApplication = async function() {
            const appId = document.getElementById('trackAppId').value.trim();
            
            if(!appId) {
                showToast('Please enter Application ID', 'error');
                return;
            }
            
            try {
                showLoading(true);
                // Search in all applications
                const appsRef = ref(database, 'allApplications');
                const snapshot = await get(appsRef);
                
                let foundApp = null;
                
                if (snapshot.exists()) {
                    const apps = snapshot.val();
                    foundApp = apps[appId];
                }
                
                if(!foundApp) {
                    showToast('Application not found. Please check the ID.', 'error');
                    showLoading(false);
                    return;
                }
                
                // Show result
                document.getElementById('resultAppId').textContent = appId;
                document.getElementById('resultService').textContent = foundApp.serviceName;
                document.getElementById('resultDate').textContent = new Date(foundApp.submittedAt).toLocaleDateString();
                
                const statusColors = {
                    'pending': '#ff9800',
                    'progress': '#2196f3',
                    'completed': '#4caf50',
                    'rejected': '#f44336'
                };
                
                const statusElement = document.getElementById('resultStatus');
                statusElement.textContent = foundApp.status.toUpperCase();
                statusElement.style.color = statusColors[foundApp.status] || '#666';
                
                // Show remarks if exists
                const remarksBox = document.getElementById('resultRemarks');
                if(foundApp.remarks) {
                    document.getElementById('remarksText').textContent = foundApp.remarks;
                    remarksBox.className = 'remarks-box ' + (foundApp.status === 'rejected' ? 'rejected' : '');
                    remarksBox.style.display = 'block';
                } else {
                    remarksBox.style.display = 'none';
                }
                
                // Update progress bar
                document.querySelectorAll('.progress-step').forEach(s => {
                    s.classList.remove('active', 'completed');
                });
                
                document.querySelector('.progress-step').classList.add('completed');
                
                if(foundApp.status === 'pending') {
                    document.getElementById('stepReview').classList.add('active');
                } else if(foundApp.status === 'progress') {
                    document.getElementById('stepReview').classList.add('completed');
                    document.getElementById('stepProcess').classList.add('active');
                } else if(foundApp.status === 'completed') {
                    ['stepReview', 'stepProcess', 'stepComplete'].forEach(id => {
                        document.getElementById(id).classList.add('completed');
                    });
                } else if(foundApp.status === 'rejected') {
                    document.getElementById('stepReview').classList.add('completed');
                }
                
                const messages = {
                    'pending': 'Your application has been received and is pending review.',
                    'progress': 'Your application is currently being processed.',
                    'completed': 'Your application has been completed successfully!',
                    'rejected': 'Unfortunately, your application was rejected. Please check remarks or contact support.'
                };
                
                document.getElementById('statusMessage').textContent = messages[foundApp.status] || 'Status unknown.';
                document.getElementById('trackingResult').classList.add('show');
                
                showLoading(false);
            } catch (error) {
                console.error('Error tracking application:', error);
                showToast('Failed to track application', 'error');
                showLoading(false);
            }
        };

        // Save Profile
        window.saveProfile = async function(e) {
            e.preventDefault();
            
            try {
                showLoading(true);
                const profileData = {
                    name: document.getElementById('profileName').value,
                    mobile: document.getElementById('profileMobile').value,
                    email: document.getElementById('profileEmail').value,
                    dob: document.getElementById('profileDob').value,
                    address: document.getElementById('profileAddress').value,
                    district: document.getElementById('profileDistrict').value,
                    state: document.getElementById('profileState').value,
                    pincode: document.getElementById('profilePincode').value,
                    aadhaar: document.getElementById('profileAadhaar').value,
                    pan: document.getElementById('profilePan').value,
                    updatedAt: Date.now()
                };
                
                await set(ref(database, `users/${currentUser.uid}`), profileData);
                
                // Update display
                document.getElementById('userName').textContent = profileData.name;
                document.getElementById('welcomeName').textContent = profileData.name;
                document.getElementById('profileNameDisplay').textContent = profileData.name;
                document.getElementById('profileEmailDisplay').textContent = profileData.email;
                
                showToast('Profile updated successfully!', 'success');
                showLoading(false);
            } catch (error) {
                console.error('Error saving profile:', error);
                showToast('Failed to update profile', 'error');
                showLoading(false);
            }
        };

        // Service Modal Functions
        window.openServiceModal = function(serviceId) {
            let service = null;
            for(let cat in servicesData) {
                service = servicesData[cat].find(s => s.id === serviceId);
                if(service) break;
            }
            
            if(!service) return;
            currentService = service;
            
            document.getElementById('modalTitle').textContent = service.name;
            document.getElementById('modalSubtitle').textContent = service.desc + ' - Complete your application';
            
            renderDocuments(service.docs);
            renderServiceFields(serviceId);
            
            document.getElementById('serviceModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        };

        function renderDocuments(docList) {
            const container = document.getElementById('documentList');
            container.innerHTML = docList.map((doc, index) => {
                const config = documentConfig[doc] || { name: doc, icon: 'fa-file', accept: '.pdf,.jpg,.jpeg,.png' };
                return `
                    <div class="document-item">
                        <label for="doc_${index}">
                            <i class="fas ${config.icon}"></i>
                            <div>
                                <div style="font-weight: 600; color: #333;">${config.name}</div>
                                <div style="font-size: 12px; color: #666; margin-top: 3px;">Click to upload (Max 5MB)</div>
                            </div>
                            <input type="file" id="doc_${index}" accept="${config.accept}" onchange="handleFileUpload('${doc}', '${index}', this)">
                        </label>
                        <div class="file-name" id="filename_${index}">
                            <i class="fas fa-check-circle" style="color: #4caf50;"></i> <span></span>
                        </div>
                        <div class="upload-progress" id="progress_${index}">
                            <div class="upload-progress-bar" id="progressBar_${index}"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderServiceFields(serviceId) {
            const container = document.getElementById('serviceSpecificFields');
            // Add service-specific fields as needed
            container.innerHTML = '<p style="color: #666; font-style: italic;">No additional information required for this service.</p>';
        }

        window.handleFileUpload = async function(docType, index, input) {
            if(input.files && input.files[0]) {
                const file = input.files[0];
                
                if(file.size > 5 * 1024 * 1024) {
                    showToast('File size too large. Maximum 5MB allowed.', 'error');
                    input.value = '';
                    return;
                }
                
                uploadedFiles[docType] = file;
                
                const fileNameDiv = document.getElementById(`filename_${index}`);
                fileNameDiv.querySelector('span').textContent = file.name;
                fileNameDiv.classList.add('show');
            }
        };

        window.closeModal = function() {
            document.getElementById('serviceModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            uploadedFiles = {};
            currentService = null;
        };

        // Submit Application to Firebase - FIXED VERSION
        window.submitApplication = async function() {
            const terms = document.getElementById('appTerms');
            if(!terms.checked) {
                showToast('Please accept the terms and conditions', 'error');
                return;
            }
            
            // Validate required fields
            const requiredFields = ['appName', 'appFatherName', 'appDob', 'appGender', 'appMobile', 'appEmail', 'appAddress', 'appDistrict', 'appState', 'appPincode'];
            for(let fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if(!field.value.trim()) {
                    showToast(`Please fill in all required fields`, 'error');
                    field.focus();
                    return;
                }
            }
            
            if(currentService && currentService.docs) {
                const missingDocs = currentService.docs.filter(doc => !uploadedFiles[doc]);
                if(missingDocs.length > 0) {
                    showToast('Please upload all required documents: ' + missingDocs.join(', '), 'error');
                    return;
                }
            }
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            showLoading(true);
            
            try {
                // Upload files to Firebase Storage
                const uploadedDocUrls = [];
                
                for (const [docType, file] of Object.entries(uploadedFiles)) {
                    try {
                        const fileRef = storageRef(storage, `documents/${currentUser.uid}/${Date.now()}_${docType}_${file.name}`);
                        const uploadResult = await uploadBytes(fileRef, file);
                        const downloadURL = await getDownloadURL(uploadResult.ref);
                        uploadedDocUrls.push({
                            type: docType,
                            name: file.name,
                            url: downloadURL,
                            uploadedAt: Date.now()
                        });
                    } catch (uploadError) {
                        console.error('File upload error:', uploadError);
                        showToast(`Failed to upload ${file.name}`, 'error');
                        throw uploadError;
                    }
                }
                
                // Create application data
                const applicationData = {
                    serviceId: currentService.id,
                    serviceName: currentService.name,
                    customerId: currentUser.uid,
                    customerEmail: currentUser.email,
                    personalInfo: {
                        name: document.getElementById('appName').value,
                        fatherName: document.getElementById('appFatherName').value,
                        dob: document.getElementById('appDob').value,
                        gender: document.getElementById('appGender').value,
                        mobile: document.getElementById('appMobile').value,
                        email: document.getElementById('appEmail').value,
                        address: document.getElementById('appAddress').value,
                        district: document.getElementById('appDistrict').value,
                        state: document.getElementById('appState').value,
                        pincode: document.getElementById('appPincode').value,
                        aadhaar: document.getElementById('appAadhaar').value || '',
                        pan: document.getElementById('appPan').value || ''
                    },
                    documents: uploadedDocUrls,
                    notes: document.getElementById('appNotes').value || '',
                    status: 'pending',
                    remarks: '',
                    submittedAt: Date.now(),
                    updatedAt: Date.now()
                };
                
                // Generate application ID
                const appId = 'APP' + Date.now();
                
                // Save to customer's applications
                await set(ref(database, `applications/${currentUser.uid}/${appId}`), applicationData);
                
                // Save to allApplications for admin access
                await set(ref(database, `allApplications/${appId}`), {
                    ...applicationData,
                    applicationId: appId
                });
                
                showToast(`Application submitted successfully! ID: ${appId}`, 'success');
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>Submit Application</span>';
                
                closeModal();
                updateStats();
                
                // Switch to applications section
                showSection('applications');
                
            } catch (error) {
                console.error('Error submitting application:', error);
                showToast('Failed to submit application: ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>Submit Application</span>';
            }
            
            showLoading(false);
        };

        // User Menu Functions
        window.toggleDropdown = function(event) {
            event.stopPropagation();
            document.getElementById('userDropdown').classList.toggle('show');
        };

        window.logout = async function() {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error signing out:', error);
                showToast('Failed to logout', 'error');
            }
        };

        window.viewDocuments = function() {
            showSection('applications');
        };

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if(!event.target.matches('.user-menu') && !event.target.matches('.user-menu *')) {
                document.getElementById('userDropdown').classList.remove('show');
            }
            if(event.target === document.getElementById('serviceModal')) {
                closeModal();
            }
        };
    </script>
</body>
</html>
